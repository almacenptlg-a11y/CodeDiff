<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeDiff Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script> 
    <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>

    <style>
        /* --- VARIABLES DE DISEÑO --- */
        :root {
            /* Paleta Oscura (Default) */
            --bg-app: #0d1117;
            --bg-panel: #161b22;
            --bg-input: #0d1117;
            --border: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            
            /* Colores de Acción */
            --primary: #238636;
            --primary-hover: #2ea043;
            --danger: #f85149;
            --danger-bg: rgba(248, 81, 73, 0.1);
            --accent: #a371f7;
            --accent-bg: rgba(163, 113, 247, 0.1);
            
            /* Diff Colors */
            --diff-add-bg: rgba(46, 160, 67, 0.15);
            --diff-add-text: #3fb950;
            --diff-del-bg: rgba(248, 81, 73, 0.15);
            --diff-del-text: #ff7b72;
            
            /* UI Elements */
            --line-num-bg: #0d1117;
            --line-num-text: #484f58;
            --drag-overlay: rgba(31, 111, 235, 0.15);
            --empty-pattern: repeating-linear-gradient(45deg, #10141a, #10141a 10px, #161b22 10px, #161b22 20px);
            
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        [data-theme="light"] {
            --bg-app: #f6f8fa;
            --bg-panel: #ffffff;
            --bg-input: #ffffff;
            --border: #d0d7de;
            --text-main: #24292f;
            --text-muted: #57606a;
            
            --primary: #1f883d;
            --primary-hover: #1a7f37;
            --danger: #cf222e;
            --accent: #8250df;
            
            --diff-add-bg: #e6ffec;
            --diff-add-text: #1a7f37;
            --diff-del-bg: #ffebe9;
            --diff-del-text: #cf222e;
            
            --line-num-bg: #f6f8fa;
            --line-num-text: #6e7781;
            --drag-overlay: rgba(9, 105, 218, 0.1);
            --empty-pattern: repeating-linear-gradient(45deg, #f6f8fa, #f6f8fa 10px, #eaeef2 10px, #eaeef2 20px);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }

        /* --- HEADER --- */
        header { 
            height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); background: var(--bg-panel); flex-shrink: 0;
        }
        
        .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }
        .brand svg { width: 24px; height: 24px; color: var(--text-main); }
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }

        /* --- BUTTONS (PROFESSIONAL DESIGN) --- */
        .toolbar { display: flex; gap: 8px; align-items: center; }
        
        .btn { 
            display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; 
            border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; 
            background: transparent; color: var(--text-main); height: 36px;
        }
        
        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* Button Variants */
        .btn-ghost { color: var(--text-muted); }
        .btn-ghost:hover { background: var(--bg-input); color: var(--text-main); }

        .btn-outline { border-color: var(--border); background: var(--bg-panel); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--text-muted); background: var(--bg-app); }

        .btn-primary { background: var(--primary); color: white; border: none; box-shadow: 0 1px 0 rgba(27,31,35,0.1); }
        .btn-primary:hover { background: var(--primary-hover); }

        .btn-danger { color: var(--danger); border-color: var(--border); }
        .btn-danger:hover { background: var(--danger-bg); border-color: var(--danger); }
        .btn-danger svg { fill: var(--danger); }

        .btn-magic { color: var(--accent); border-color: var(--border); }
        .btn-magic:hover { background: var(--accent-bg); border-color: var(--accent); }
        .btn-magic svg { fill: var(--accent); }

        .separator { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }

        /* --- MAIN LAYOUT --- */
        main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; min-height: 0; }

        /* --- INPUT AREA --- */
        #input-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex-grow: 1; min-height: 0; }
        
        .editor-container { position: relative; display: flex; flex-direction: column; height: 100%; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--bg-panel); transition: border-color 0.2s; }
        .editor-container:focus-within { border-color: var(--text-muted); }
        
        .editor-header { padding: 8px 12px; background: var(--bg-app); border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; display: flex; justify-content: space-between; }
        
        textarea { width: 100%; height: 100%; background: var(--bg-panel); color: var(--text-main); border: none; padding: 15px; font-family: 'ui-monospace', 'SFMono-Regular', 'SF Mono', 'Menlo', 'Consolas', monospace; font-size: 13px; resize: none; outline: none; line-height: 1.6; }

        /* Drag Overlay */
        .drop-overlay { 
            position: absolute; inset: 0; background: var(--bg-panel); opacity: 0.95; 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 10; backdrop-filter: blur(4px);
        }
        .editor-container.dragging .drop-overlay { display: flex; border: 2px dashed #1f6feb; }
        .drop-icon { width: 48px; height: 48px; color: #1f6feb; margin-bottom: 10px; }
        .drop-text { color: #1f6feb; font-weight: 600; font-size: 14px; }

        /* --- RESULT AREA --- */
        #result-area { display: none; flex-grow: 1; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-panel); overflow: auto; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-family: 'ui-monospace', monospace; font-size: 13px; }
        td { padding: 0; vertical-align: top; line-height: 1.6; height: 1.6em; }
        
        .line-num { width: 50px; text-align: right; padding-right: 12px; user-select: none; color: var(--line-num-text); background: var(--line-num-bg); border-right: 1px solid var(--border); font-size: 11px; padding-top: 2px; }
        .code-col { width: 50%; white-space: pre-wrap; word-break: break-all; padding-left: 12px; color: var(--text-main); }

        /* --- DIFF HIGHLIGHTS --- */
        .bg-add { background-color: var(--diff-add-bg); }
        .bg-del { background-color: var(--diff-del-bg); }
        
        .word-add { background-color: var(--diff-add-text); color: #fff; border-radius: 2px; padding: 0 1px; }
        [data-theme="light"] .word-add { color: #fff; }
        
        .word-del { background-color: var(--diff-del-text); color: #fff; border-radius: 2px; padding: 0 1px; text-decoration: none; }
        
        .empty-cell { background: var(--empty-pattern); }

        .hidden { display: none !important; }
        
        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #24292f; color: #fff; text-align: center; border-radius: 6px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 14px; font-weight: 500; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        #toast.show { visibility: visible; animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        
        @keyframes slideUp { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
    </style>
</head>
<body data-theme="dark">

    <header>
        <div class="brand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>CodeDiff</span>
            <span class="badge">Pro</span>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-ghost" onclick="toggleTheme()" title="Cambiar Tema">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            
            <div class="separator"></div>

            <button class="btn btn-magic" onclick="formatBoth()" title="Reestructurar código">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Formatear
            </button>

            <button class="btn btn-outline" onclick="swapTexts()" title="Intercambiar textos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Swap
            </button>

            <button class="btn btn-danger" onclick="limpiar()" title="Borrar todo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Borrar
            </button>
            
            <div class="separator"></div>

            <button class="btn btn-outline" onclick="volverEditar()" id="btn-edit" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Editar
            </button>

            <button class="btn btn-primary" onclick="comparar()" id="btn-compare">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Comparar
            </button>
        </div>
    </header>

    <main>
        <div id="input-area">
            <div class="editor-container" id="drop1">
                <div class="editor-header">
                    <span>Original</span>
                    <span>Javascript / HTML / Text</span>
                </div>
                <textarea id="text1" placeholder="// Pega tu código original aquí o arrastra un archivo..."></textarea>
                <div class="drop-overlay">
                    <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span class="drop-text">Suelta el archivo aquí</span>
                </div>
            </div>

            <div class="editor-container" id="drop2">
                <div class="editor-header">
                    <span>Modificado</span>
                    <span>Javascript / HTML / Text</span>
                </div>
                <textarea id="text2" placeholder="// Pega tu código modificado aquí o arrastra un archivo..."></textarea>
                <div class="drop-overlay">
                    <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span class="drop-text">Suelta el archivo aquí</span>
                </div>
            </div>
        </div>

        <div id="result-area">
            <table id="diff-table"><tbody></tbody></table>
        </div>
    </main>

    <div id="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span id="toast-msg">Mensaje</span>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const escapeHtml = text => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

        /* --- DRAG & DROP --- */
        function setupDragDrop(containerId, textareaId) {
            const container = $(containerId);
            const textarea = $(textareaId);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                container.addEventListener(e, (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                }, false);
            });

            container.addEventListener('dragover', () => container.classList.add('dragging'));
            container.addEventListener('dragleave', () => container.classList.remove('dragging'));
            
            container.addEventListener('drop', (e) => {
                container.classList.remove('dragging');
                const file = e.dataTransfer.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        textarea.value = event.target.result;
                        showToast(`Archivo cargado: ${file.name}`);
                    };
                    reader.readAsText(file);
                }
            });
        }
        setupDragDrop('drop1', 'text1');
        setupDragDrop('drop2', 'text2');

        /* --- THEME --- */
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            
            // Cambiar icono del sol/luna
            const icon = document.getElementById('theme-icon');
            if (isDark) { // Change to Sun
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            } else { // Change to Moon
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            }
        }

        /* --- ACTIONS --- */
        function swapTexts() {
            const t1 = $('text1');
            const t2 = $('text2');
            [t1.value, t2.value] = [t2.value, t1.value];
            showToast("Textos intercambiados");
            if ($('result-area').style.display !== 'none') comparar();
        }

        function limpiar() {
            $('text1').value = '';
            $('text2').value = '';
            volverEditar();
            showToast("Editor limpiado");
        }

        function volverEditar() {
            $('input-area').classList.remove('hidden');
            $('result-area').style.display = 'none';
            $('btn-edit').style.display = 'none';
            $('btn-compare').style.display = 'inline-flex';
        }

        function showToast(msg) {
            const t = $("toast");
            $("toast-msg").innerText = msg;
            t.className = "show";
            setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }

        /* --- FORMATTER --- */
        function formatCode(code) {
            try {
                return prettier.format(code, { parser: "html", plugins: prettierPlugins, tabWidth: 4, useTabs: false });
            } catch (e) {
                try {
                    return prettier.format(code, { parser: "babel", plugins: prettierPlugins });
                } catch (e2) { return null; }
            }
        }

        function formatBoth() {
            const t1 = $('text1');
            const t2 = $('text2');
            if (!t1.value.trim() && !t2.value.trim()) return showToast("El editor está vacío");
            
            const f1 = formatCode(t1.value);
            const f2 = formatCode(t2.value);
            
            if (f1) t1.value = f1;
            if (f2) t2.value = f2;
            
            showToast(f1 || f2 ? "Código formateado" : "No se pudo formatear (Syntax Error)");
        }

        /* --- COMPARISON LOGIC --- */
        function getInlineDiff(oldText, newText) {
            if (oldText === newText) return escapeHtml(newText);
            return Diff.diffWordsWithSpace(oldText, newText).map(p => {
                const esc = escapeHtml(p.value);
                return p.added ? `<span class="word-add">${esc}</span>` : 
                       p.removed ? `<span class="word-del">${esc}</span>` : esc;
            }).join('');
        }

        function comparar() {
            const t1 = $('text1').value;
            const t2 = $('text2').value;
            if(!t1 && !t2) return showToast("Pega algún código para comparar");

            const tbody = document.querySelector('#diff-table tbody');
            tbody.innerHTML = '';

            const diffLines = Diff.diffLines(t1, t2);
            let lLeft = 1, lRight = 1;

            for (let i = 0; i < diffLines.length; i++) {
                const part = diffLines[i];
                const lines = part.value.replace(/\n$/, '').split('\n');

                // MODIFICADO (Bloque Borrado + Bloque Agregado)
                if (part.removed && diffLines[i+1] && diffLines[i+1].added) {
                    const nextPart = diffLines[i+1];
                    const nextLines = nextPart.value.replace(/\n$/, '').split('\n');
                    const max = Math.max(lines.length, nextLines.length);

                    for (let j = 0; j < max; j++) {
                        const txtL = lines[j];
                        const txtR = nextLines[j];
                        let html = '<tr>';

                        // Columna Izquierda
                        if (txtL !== undefined) {
                            const content = (txtR !== undefined) ? getInlineDiff(txtL, txtR).replace(/<span class="word-add">.*?<\/span>/g, '') : escapeHtml(txtL);
                            html += `<td class="line-num bg-del">${lLeft++}</td><td class="code-col bg-del">${content}</td>`;
                        } else {
                            html += `<td class="line-num empty-cell"></td><td class="code-col empty-cell"></td>`;
                        }

                        // Columna Derecha
                        if (txtR !== undefined) {
                            const content = (txtL !== undefined) ? getInlineDiff(txtL, txtR).replace(/<span class="word-del">.*?<\/span>/g, '') : escapeHtml(txtR);
                            html += `<td class="line-num bg-add">${lRight++}</td><td class="code-col bg-add">${content}</td>`;
                        } else {
                            html += `<td class="line-num empty-cell"></td><td class="code-col empty-cell"></td>`;
                        }
                        tbody.insertAdjacentHTML('beforeend', html + '</tr>');
                    }
                    i++; 
                }
                // SOLO BORRADO
                else if (part.removed) {
                    lines.forEach(line => {
                        tbody.insertAdjacentHTML('beforeend', `<tr><td class="line-num bg-del">${lLeft++}</td><td class="code-col bg-del"><span class="word-del">${escapeHtml(line)}</span></td><td class="line-num empty-cell"></td><td class="code-col empty-cell"></td></tr>`);
                    });
                }
                // SOLO AGREGADO
                else if (part.added) {
                    lines.forEach(line => {
                        tbody.insertAdjacentHTML('beforeend', `<tr><td class="line-num empty-cell"></td><td class="code-col empty-cell"></td><td class="line-num bg-add">${lRight++}</td><td class="code-col bg-add"><span class="word-add">${escapeHtml(line)}</span></td></tr>`);
                    });
                }
                // IGUAL
                else {
                    lines.forEach(line => {
                        tbody.insertAdjacentHTML('beforeend', `<tr><td class="line-num">${lLeft++}</td><td class="code-col">${escapeHtml(line)}</td><td class="line-num">${lRight++}</td><td class="code-col">${escapeHtml(line)}</td></tr>`);
                    });
                }
            }

            $('input-area').classList.add('hidden');
            $('result-area').style.display = 'block';
            $('btn-compare').style.display = 'none';
            $('btn-edit').style.display = 'inline-flex';
        }
    </script>
</body>
</html>
